<!DOCTYPE html>
<html lang="zh-CN">
<!--
  超强防封系统 - 智能随机化跳转页面
  开发者：伟大的伟
  版本：v3.0 - 自动随机化版
  修改日期：2025-10-07
  
  ⚡ 特性：
  - 每次访问自动随机化页面特征
  - 防止特征识别和封禁
  - 智能反爬虫机制
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title id="page-title">加载中...</title>
    <style id="dynamic-styles">
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            overflow: hidden;
        }
        
        .container {
            text-align: center;
            padding: 40px;
            max-width: 400px;
            position: relative;
            z-index: 10;
        }
        
        .logo {
            width: var(--logo-size);
            height: var(--logo-size);
            margin: 0 auto 20px;
            background: white;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--icon-size);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: pulse var(--pulse-duration) ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(var(--pulse-scale)); }
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: var(--spinner-size);
            height: var(--spinner-size);
            animation: spin var(--spin-duration) linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        h1 {
            font-size: var(--title-size);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        #status {
            opacity: 0.9;
            font-size: var(--text-size);
            line-height: 1.6;
        }
        
        .error {
            color: #fff;
            background: rgba(255, 107, 107, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        .error-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: var(--progress-height);
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            animation: progress var(--progress-duration) ease-out forwards;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }
        
        .particle {
            position: absolute;
            width: var(--particle-size);
            height: var(--particle-size);
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            animation: float var(--float-duration) infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(100px); opacity: 0; }
        }
        
        .safe-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(16, 185, 129, 0.2);
            padding: var(--badge-padding);
            border-radius: 20px;
            font-size: var(--badge-size);
            margin-top: 10px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .safe-icon {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <!-- 背景粒子效果 -->
    <div class="particles" id="particles"></div>
    
    <div class="container">
        <div class="logo" id="logo-icon">🔐</div>
        <div class="spinner"></div>
        <h1 id="main-title">安全跳转中</h1>
        <p id="status">正在验证链接安全性...</p>
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
        <div class="safe-badge" id="badge">
            <svg class="safe-icon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span id="badge-text">已加密保护</span>
        </div>
    </div>
    
    <script>
        // ==================== 🎲 随机化引擎 ====================
        const RandomEngine = {
            // 随机整数
            int(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            },
            
            // 随机浮点数
            float(min, max, decimals = 2) {
                return parseFloat((Math.random() * (max - min) + min).toFixed(decimals));
            },
            
            // 随机选择
            pick(array) {
                return array[Math.floor(Math.random() * array.length)];
            },
            
            // 随机颜色
            color() {
                return '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            },
            
            // 随机渐变
            gradient() {
                const gradients = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                    'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                    'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                    'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)',
                    'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)',
                    'linear-gradient(135deg, #f68084 0%, #fccb90 100%)',
                    'linear-gradient(135deg, #fdcbf1 0%, #e6dee9 100%)',
                    'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)',
                    'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)',
                    'linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)',
                    'linear-gradient(135deg, #fddb92 0%, #d1fdff 100%)',
                    'linear-gradient(135deg, #9890e3 0%, #b1f4cf 100%)',
                    'linear-gradient(135deg, #ebc0fd 0%, #d9ded8 100%)',
                    'linear-gradient(135deg, #96fbc4 0%, #f9f586 100%)'
                ];
                return this.pick(gradients);
            },
            
            // 随机标题
            title() {
                const titles = [
                    '正在跳转...', '安全跳转中', '链接验证中', '加载中...',
                    '页面跳转', '正在连接', '安全访问', '验证中...',
                    '跳转处理中', '链接加载中', '安全检测中', '即将跳转',
                    '处理中...', '访问验证', '链接解析中', '正在加载'
                ];
                return this.pick(titles);
            },
            
            // 随机主标题
            mainTitle() {
                const titles = [
                    '安全跳转中', '正在跳转', '链接验证中', '加载中',
                    '页面跳转', '安全访问', '验证中', '即将跳转',
                    '正在处理', '链接加载', '安全检测', '跳转中'
                ];
                return this.pick(titles);
            },
            
            // 随机徽章文字
            badgeText() {
                const badges = [
                    '已加密保护', '安全链接', '已验证', '安全访问',
                    '加密传输', '安全保障', '已认证', '安全连接',
                    '防护中', '保护中', '加密中', '安全通道'
                ];
                return this.pick(badges);
            },
            
            // 随机图标
            icon() {
                const icons = ['🔐', '🔒', '✓', '✔️', '🛡️', '⚡', '🔑', '⭐', '💫', '🌟'];
                return this.pick(icons);
            },
            
            // 随机CSS变量
            cssVars() {
                return {
                    '--bg-gradient': this.gradient(),
                    '--logo-size': this.int(70, 90) + 'px',
                    '--border-radius': this.int(15, 25) + 'px',
                    '--icon-size': this.int(35, 45) + 'px',
                    '--pulse-duration': this.float(1.5, 2.5) + 's',
                    '--pulse-scale': this.float(1.03, 1.08),
                    '--spinner-size': this.int(45, 55) + 'px',
                    '--spin-duration': this.float(0.8, 1.2) + 's',
                    '--title-size': this.int(22, 26) + 'px',
                    '--text-size': this.int(13, 15) + 'px',
                    '--progress-height': this.int(3, 5) + 'px',
                    '--progress-duration': this.float(1.8, 2.5) + 's',
                    '--particle-size': this.int(8, 12) + 'px',
                    '--float-duration': this.int(12, 18) + 's',
                    '--badge-padding': this.int(5, 8) + 'px ' + this.int(10, 14) + 'px',
                    '--badge-size': this.int(11, 13) + 'px'
                };
            }
        };
        
        // ==================== 🎨 应用随机化 ====================
        function applyRandomization() {
            // 1. 随机化CSS变量
            const cssVars = RandomEngine.cssVars();
            const root = document.documentElement;
            Object.entries(cssVars).forEach(([key, value]) => {
                root.style.setProperty(key, value);
            });
            
            // 2. 随机化页面标题
            document.getElementById('page-title').textContent = RandomEngine.title();
            
            // 3. 随机化主标题
            document.getElementById('main-title').textContent = RandomEngine.mainTitle();
            
            // 4. 随机化徽章文字
            document.getElementById('badge-text').textContent = RandomEngine.badgeText();
            
            // 5. 随机化图标
            document.getElementById('logo-icon').textContent = RandomEngine.icon();
            
            // 6. 随机化粒子数量
            const particleCount = RandomEngine.int(15, 30);
            createParticles(particleCount);
            
            // 7. 随机化跳转延迟
            CONFIG.REDIRECT_DELAY = RandomEngine.int(600, 1200);
            
            // 8. 随机化状态文本
            randomizeStatusTexts();
            
            // 9. 随机化meta标签
            randomizeMetaTags();
            
            console.log('🎲 随机化已应用', cssVars);
        }
        
        // ==================== 📝 随机化状态文本 ====================
        const statusTexts = {
            checking: [
                '正在检测浏览器环境...', '验证运行环境...', '环境检测中...',
                '浏览器验证中...', '安全检测中...', '环境分析中...'
            ],
            parsing: [
                '正在解析链接...', '链接分析中...', '解析数据中...',
                '数据处理中...', '链接验证中...', '解析中...'
            ],
            decrypting: [
                '正在解密数据...', '数据解密中...', '安全解密中...',
                '解密处理中...', '验证数据中...', '解密中...'
            ],
            verifying: [
                '正在验证链接有效期...', '有效期检测中...', '时间验证中...',
                '有效性检查中...', '链接验证中...', '检查中...'
            ],
            signature: [
                '正在验证签名...', '签名检测中...', '安全验证中...',
                '签名验证中...', '完整性检查中...', '验证中...'
            ],
            validating: [
                '正在验证目标地址...', '地址验证中...', '目标检测中...',
                'URL验证中...', '地址检查中...', '验证中...'
            ],
            wechat: [
                '建议在微信中打开', '推荐使用微信访问', '微信中体验更佳',
                '请在微信中打开', '微信访问更安全', '建议微信打开'
            ]
        };
        
        function randomizeStatusTexts() {
            // 缓存随机文本供后续使用
            window._randomTexts = {
                checking: RandomEngine.pick(statusTexts.checking),
                parsing: RandomEngine.pick(statusTexts.parsing),
                decrypting: RandomEngine.pick(statusTexts.decrypting),
                verifying: RandomEngine.pick(statusTexts.verifying),
                signature: RandomEngine.pick(statusTexts.signature),
                validating: RandomEngine.pick(statusTexts.validating),
                wechat: RandomEngine.pick(statusTexts.wechat)
            };
        }
        
        // ==================== 🏷️ 随机化Meta标签 ====================
        function randomizeMetaTags() {
            const descriptions = [
                '安全链接跳转服务', '智能链接中转', '安全访问通道',
                '链接安全验证', '加密链接服务', '安全跳转中心',
                '智能跳转服务', '链接保护系统', '安全访问服务'
            ];
            
            const keywords = [
                '跳转,安全,链接', '中转,验证,加密', '安全,访问,保护',
                '跳转,智能,安全', '链接,防护,中转', '安全,验证,跳转'
            ];
            
            // 创建或更新description
            let metaDesc = document.querySelector('meta[name="description"]');
            if (!metaDesc) {
                metaDesc = document.createElement('meta');
                metaDesc.name = 'description';
                document.head.appendChild(metaDesc);
            }
            metaDesc.content = RandomEngine.pick(descriptions);
            
            // 创建或更新keywords
            let metaKeywords = document.querySelector('meta[name="keywords"]');
            if (!metaKeywords) {
                metaKeywords = document.createElement('meta');
                metaKeywords.name = 'keywords';
                document.head.appendChild(metaKeywords);
            }
            metaKeywords.content = RandomEngine.pick(keywords);
        }
        
        // ==================== 配置 ====================
        const CONFIG = {
            ENCRYPT_KEY: 'MH-ANTI-BLOCK-2024',  // 必须与后端一致
            LINK_EXPIRE_TIME: 24 * 60 * 60 * 1000, // 链接有效期（24小时）
            REDIRECT_DELAY: 800, // 跳转延迟（会被随机化）
            ENABLE_WECHAT_CHECK: true, // 是否启用微信检测
            ENABLE_EXPIRE_CHECK: true, // 是否启用过期检测
            ENABLE_SIGNATURE_CHECK: true, // 是否启用签名验证
        };
        
        // ==================== 立即应用随机化 ====================
        applyRandomization();
        
        // ==================== 防调试 ====================
        (function preventDebug() {
            // 禁用右键
            document.addEventListener('contextmenu', e => e.preventDefault());
            
            // 禁用F12和快捷键
            document.addEventListener('keydown', e => {
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key)) ||
                    (e.ctrlKey && e.key === 'U')) {
                    e.preventDefault();
                }
            });
            
            // 检测开发者工具
            const devtools = /./;
            devtools.toString = function() { this.opened = true; }
            const checkInterval = RandomEngine.int(800, 1500); // 随机检测间隔
            setInterval(() => {
                console.log(devtools);
                if (devtools.opened) {
                    // 检测到开发者工具
                }
            }, checkInterval);
        })();
        
        // ==================== 背景粒子效果 ====================
        function createParticles(count = 20) {
            const container = document.getElementById('particles');
            container.innerHTML = ''; // 清空
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = RandomEngine.float(0, 15) + 's';
                particle.style.animationDuration = RandomEngine.float(12, 20) + 's';
                particle.style.opacity = RandomEngine.float(0.3, 0.7);
                container.appendChild(particle);
            }
        }
        
        // ==================== User-Agent 检测 ====================
        function getUserAgent() {
            const ua = navigator.userAgent.toLowerCase();
            return {
                isWeChat: /micromessenger/i.test(ua),
                isQQ: /qq\//i.test(ua),
                isWeibo: /weibo/i.test(ua),
                isAndroid: /android/i.test(ua),
                isIOS: /iphone|ipad|ipod/i.test(ua),
                isMobile: /mobile/i.test(ua) || /android/i.test(ua) || /iphone|ipad|ipod/i.test(ua),
                full: ua
            };
        }
        
        // ==================== URL参数获取 ====================
        function getUrlParam() {
            // 支持多种参数名
            const params = ['c', 'url', 'link', 'u', 't', 'goto', 'redirect', 'target', 'ref'];
            const urlParams = new URLSearchParams(window.location.search);
            
            for (let param of params) {
                const value = urlParams.get(param);
                if (value) return value;
            }
            return null;
        }
        
        // Base64解码（自定义实现，支持所有字节值）
        function base64Decode(str) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
            const lookup = {};
            for (let i = 0; i < chars.length; i++) {
                lookup[chars[i]] = i;
            }
            
            const bytes = [];
            
            for (let i = 0; i < str.length; i += 4) {
                const a = lookup[str[i]] || 0;
                const b = lookup[str[i + 1]] || 0;
                const c = lookup[str[i + 2]] || 0;
                const d = lookup[str[i + 3]] || 0;
                
                const bitmap = (a << 18) | (b << 12) | (c << 6) | d;
                
                bytes.push((bitmap >> 16) & 255);
                if (str[i + 2] !== '=') bytes.push((bitmap >> 8) & 255);
                if (str[i + 3] !== '=') bytes.push(bitmap & 255);
            }
            
            return bytes;
        }
        
        // ==================== 解密附加参数（支持Unicode）====================
        function decryptParams(encryptedParams) {
            if (!encryptedParams) return {};
            
            try {
                // 还原URL安全的Base64
                const base64 = encryptedParams.replace(/-/g, '+').replace(/_/g, '/');
                // 补充可能缺失的=号
                const paddedBase64 = base64 + '==='.slice(0, (4 - base64.length % 4) % 4);
                
                // Base64解码为字节数组（使用自定义函数）
                const encryptedBytes = base64Decode(paddedBase64);
                
                // 将密钥也转为UTF-8字节数组（关键修复！）
                const encoder = new TextEncoder();
                const keyBytes = encoder.encode(CONFIG.ENCRYPT_KEY);
                
                // XOR解密字节数组
                const decryptedBytes = [];
                for (let i = 0; i < encryptedBytes.length; i++) {
                    decryptedBytes.push(
                        encryptedBytes[i] ^ keyBytes[i % keyBytes.length]
                    );
                }
                
                // 字节数组转UTF-8字符串
                const decoder = new TextDecoder();
                const result = decoder.decode(new Uint8Array(decryptedBytes));
                
                // 解析JSON
                return JSON.parse(result);
            } catch (error) {
                console.warn('参数解密失败，使用默认值:', error);
                return {};
            }
        }
        
        // ==================== XOR解密 ====================
        function xorDecrypt(str, key) {
            try {
                const decoded = atob(str); // Base64解码
                let result = '';
                for (let i = 0; i < decoded.length; i++) {
                    result += String.fromCharCode(
                        decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length)
                    );
                }
                return result;
            } catch(e) {
                throw new Error('解密失败');
            }
        }
        
        // ==================== 签名验证 ====================
        function verifySignature(url, timestamp, signature) {
            const raw = url + timestamp + CONFIG.ENCRYPT_KEY;
            let hash = 0;
            for (let i = 0; i < raw.length; i++) {
                const char = raw.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            const computed = Math.abs(hash).toString(36);
            return computed === signature;
        }
        
        // ==================== 显示错误 ====================
        function showError(message, details = '') {
            const container = document.querySelector('.container');
            const errorIcon = RandomEngine.pick(['⚠️', '❌', '⛔', '🚫']);
            container.innerHTML = `
                <div class="error">
                    <div class="error-icon">${errorIcon}</div>
                    <h2 style="margin-bottom: 10px;">${message}</h2>
                    ${details ? `<p style="font-size: 13px; opacity: 0.8;">${details}</p>` : ''}
                </div>
            `;
        }
        
        // ==================== 更新状态（使用随机文本） ====================
        function updateStatus(type) {
            const text = window._randomTexts[type] || type;
            document.getElementById('status').textContent = text;
        }
        
        // ==================== 智能重试机制 ====================
        async function retryRedirect(fn, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    console.warn(`尝试 ${i + 1}/${maxRetries} 失败:`, error);
                    if (i < maxRetries - 1) {
                        document.getElementById('status').textContent = `正在重试... (${i + 1}/${maxRetries})`;
                        await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                    } else {
                        throw error;
                    }
                }
            }
        }
        
        // ==================== 主跳转逻辑 ====================
        (async function redirect() {
            try {
                // 1. 检测User-Agent
                const ua = getUserAgent();
                updateStatus('checking');
                
                if (CONFIG.ENABLE_WECHAT_CHECK && !ua.isWeChat && !ua.isQQ) {
                    updateStatus('wechat');
                    // return; // 取消这行注释可强制只允许微信访问
                }
                
                // 2. 获取并解密附加参数
                const urlParams = new URLSearchParams(window.location.search);
                const encryptedParams = urlParams.get('p');
                
                console.log('🔐 加密参数 p:', encryptedParams);
                
                const additionalParams = decryptParams(encryptedParams);
                
                console.log('🔓 解密参数:', additionalParams);
                
                // 从解密后的参数中提取（优先）或从URL中获取（兼容旧链接）
                const mode = additionalParams.mode || urlParams.get('mode');
                const requiredEnv = additionalParams.env || urlParams.get('env');
                const apiServer = additionalParams.api || urlParams.get('api');
                
                console.log('✅ 最终使用参数:', {
                    mode: mode,
                    env: requiredEnv,
                    api: apiServer
                });
                
                // 3. 获取加密的主URL参数
                updateStatus('parsing');
                const encodedData = getUrlParam();
                
                if (!encodedData) {
                    throw new Error('缺少必要参数，请检查链接是否完整');
                }
                
                // 4. 解码URL参数
                const decodedParam = decodeURIComponent(encodedData);
                
                // 4. 解密数据
                updateStatus('decrypting');
                const decrypted = xorDecrypt(decodedParam, CONFIG.ENCRYPT_KEY);
                const payload = JSON.parse(decrypted);
                
                // 5. 验证数据结构
                if (!payload.u || !payload.t || !payload.s) {
                    throw new Error('数据格式错误');
                }
                
                const { u, t: timestamp, s: signature, v: version } = payload;
                let targetUrl = u;  // 使用let以便后续可以修改
                
                // 6. 验证时间戳（防止链接过期）
                if (CONFIG.ENABLE_EXPIRE_CHECK) {
                    updateStatus('verifying');
                    const now = Date.now();
                    const age = now - timestamp;
                    
                    if (age > CONFIG.LINK_EXPIRE_TIME) {
                        throw new Error('链接已过期，请重新生成');
                    }
                    
                    if (age < -60000) { // 时间戳不能是未来
                        throw new Error('链接时间异常');
                    }
                }
                
                // 7. 验证签名（使用原始URL）
                if (CONFIG.ENABLE_SIGNATURE_CHECK) {
                    updateStatus('signature');
                    if (!verifySignature(u, timestamp, signature)) {
                        throw new Error('签名验证失败，链接可能已被篡改');
                    }
                }
                
                // 8. 验证目标URL格式
                updateStatus('validating');
                if (!/^https?:\/\//i.test(targetUrl)) {
                    throw new Error('目标地址格式错误');
                }
                
                // 8.5 🔒 自动升级 HTTP → HTTPS（已禁用，支持 HTTP 跳转）
                // 注意：如果中转域名是 HTTPS，目标是 HTTP，浏览器可能会显示混合内容警告
                // 如需自动升级，取消下面代码的注释：
                /*
                if (window.location.protocol === 'https:' && targetUrl.startsWith('http://')) {
                    const httpsUrl = targetUrl.replace(/^http:\/\//i, 'https://');
                    console.log(`🔒 检测到混合内容，自动升级:\n   HTTP:  ${targetUrl}\n   HTTPS: ${httpsUrl}`);
                    targetUrl = httpsUrl;
                }
                */
                
                // 9. 显示目标域名（可选）
                try {
                    const hostname = new URL(targetUrl).hostname;
                    document.getElementById('status').textContent = `即将跳转到 ${hostname}`;
                } catch(e) {
                    document.getElementById('status').textContent = '即将跳转...';
                }
                
                //  10. 检查环境限制（使用解密后的参数）
                if (requiredEnv && requiredEnv !== 'all') {
                    const currentEnv = detectCurrentEnvironment();
                    
                    if (currentEnv !== requiredEnv) {
                        // 环境不匹配，显示提示页面
                        showEnvironmentRestriction(requiredEnv, currentEnv);
                        return; // 终止跳转
                    }
                }
                
                // 11. 上报成功统计（使用解密后的API服务器地址）
                reportAccess(targetUrl, true, apiServer);
                
                // 12. 检测是否使用iframe嵌套模式（使用解密后的mode参数）
                const isIframeMode = mode === 'iframe';
                
                if (isIframeMode) {
                    // ==================== iframe嵌套模式 - 强力防封 ====================
                    // 更新状态提示
                    document.getElementById('status').textContent = '正在加载内容...';
                    
                    // 延迟一下再显示iframe（更自然）
                    const randomDelay = CONFIG.REDIRECT_DELAY + RandomEngine.int(-200, 200);
                    await new Promise(resolve => setTimeout(resolve, randomDelay));
                    
                    // 清空页面并创建iframe容器
                    document.body.innerHTML = '';
                    document.body.style.margin = '0';
                    document.body.style.padding = '0';
                    document.body.style.overflow = 'hidden';
                    
                    const iframe = document.createElement('iframe');
                    iframe.src = targetUrl;
                    iframe.style.cssText = 'width:100%;height:100vh;border:none;position:fixed;top:0;left:0;z-index:999999;';
                    iframe.setAttribute('allowfullscreen', 'true');
                    iframe.setAttribute('allow', 'geolocation; microphone; camera');
                    
                    // 处理iframe加载错误（跨域限制）
                    iframe.onerror = function() {
                        document.body.innerHTML = `
                            <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;text-align:center;font-family:Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
                                <div style="background:white;padding:40px;border-radius:12px;max-width:500px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                                    <div style="font-size:64px;margin-bottom:20px;">⚠️</div>
                                    <h2 style="color:#333;margin-bottom:15px;">无法在当前环境加载</h2>
                                    <p style="color:#666;margin-bottom:25px;">目标网站设置了安全策略，请点击下方按钮访问</p>
                                    <a href="${targetUrl}" style="display:inline-block;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:15px 30px;border-radius:8px;text-decoration:none;font-weight:bold;">直接访问</a>
                                </div>
                            </div>
                        `;
                    };
                    
                    document.body.appendChild(iframe);
                    
                    console.log('✅ iframe嵌套模式已启用，地址栏显示中转域名');
                    
                } else {
                    // ==================== 普通跳转模式 ====================
                    // 12. 智能重试跳转
                    const startTime = Date.now();
                    await retryRedirect(async () => {
                        // 预检测目标URL是否可达
                        try {
                            await fetch(new URL(targetUrl).origin, { 
                                method: 'HEAD', 
                                mode: 'no-cors',
                                cache: 'no-cache'
                            });
                        } catch(e) {
                            console.warn('目标可达性检测失败，但继续跳转');
                        }
                        
                        // 记录响应时间
                        const responseTime = Date.now() - startTime;
                        
                        // 上报域名健康
                        try {
                            const domain = new URL(targetUrl).origin;
                            reportDomainHealth(domain, true, responseTime);
                        } catch(e) {}
                        
                        // 随机延迟跳转（增加不可预测性）
                        const randomDelay = CONFIG.REDIRECT_DELAY + RandomEngine.int(-200, 200);
                        await new Promise(resolve => setTimeout(resolve, randomDelay));
                        
                        // 跳转方式1：直接跳转（推荐）
                        window.location.href = targetUrl;
                        
                        // 跳转方式2：replace跳转（不留历史记录）
                        // window.location.replace(targetUrl);
                        
                        return true;
                    }, 3, 2000); // 最多重试3次，每次延迟2秒
                }
                
            } catch(error) {
                console.error('跳转失败:', error);
                
                // 上报失败统计
                reportAccess('', false);
                
                showError(error.message || '链接解析失败', '请确认链接是否正确，或联系管理员');
            }
        })();
        
        // ==================== 检测当前环境 ====================
        function detectCurrentEnvironment() {
            const ua = navigator.userAgent;
            const uaLower = ua.toLowerCase();
            
            // 微信检测
            if (ua.indexOf('MicroMessenger') !== -1) {
                return 'weixin';
            }
            
            // QQ检测（多种识别方式）
            if (ua.indexOf('QQ/') !== -1 
                || uaLower.indexOf('mqqbrowser') !== -1
                || ua.indexOf('Tim/') !== -1
                || uaLower.indexOf('qzone') !== -1) {
                return 'qq';
            }
            
            // 其他都认为是浏览器
            return 'browser';
        }
        
        // ==================== 显示环境限制提示 ====================
        function showEnvironmentRestriction(requiredEnv, currentEnv) {
            const envNames = {
                'weixin': '💬 微信',
                'qq': '🐧 QQ',
                'browser': '🌐 浏览器'
            };
            
            const envColors = {
                'weixin': '#07c160',
                'qq': '#12b7f5',
                'browser': '#667eea'
            };
            
            const requiredName = envNames[requiredEnv] || '未知';
            const currentName = envNames[currentEnv] || '未知';
            const primaryColor = envColors[requiredEnv] || '#667eea';
            
            let steps = '';
            if (requiredEnv === 'weixin') {
                steps = `
                    <div class="steps">
                        <h3>📱 如何在微信中打开？</h3>
                        <ol>
                            <li>长按此链接，选择"复制"</li>
                            <li>打开微信APP</li>
                            <li>在任意聊天窗口粘贴链接</li>
                            <li>点击链接即可访问</li>
                        </ol>
                    </div>
                `;
            } else if (requiredEnv === 'qq') {
                steps = `
                    <div class="steps">
                        <h3>🐧 如何在QQ中打开？</h3>
                        <ol>
                            <li>长按此链接，选择"复制"</li>
                            <li>打开QQ APP</li>
                            <li>在任意聊天窗口粘贴链接</li>
                            <li>点击链接即可访问</li>
                        </ol>
                    </div>
                `;
            } else if (requiredEnv === 'browser') {
                steps = `
                    <div class="steps">
                        <h3>🌐 如何在浏览器中打开？</h3>
                        <ol>
                            <li>点击右上角"..."菜单</li>
                            <li>选择"在浏览器中打开"</li>
                            <li>或复制链接到浏览器地址栏访问</li>
                        </ol>
                    </div>
                `;
            }
            
            document.body.innerHTML = `
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
                        background: linear-gradient(135deg, ${primaryColor} 0%, #764ba2 100%);
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    }
                    .container {
                        background: rgba(255, 255, 255, 0.95);
                        border-radius: 20px;
                        padding: 40px 30px;
                        max-width: 400px;
                        text-align: center;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        animation: slideUp 0.5s ease;
                    }
                    @keyframes slideUp {
                        from { opacity: 0; transform: translateY(30px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    .icon {
                        font-size: 80px;
                        margin-bottom: 20px;
                        animation: bounce 2s infinite;
                    }
                    @keyframes bounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-10px); }
                    }
                    h1 { color: #1e293b; font-size: 24px; margin-bottom: 15px; }
                    .message { color: #64748b; font-size: 16px; line-height: 1.8; margin-bottom: 25px; }
                    .env-info {
                        background: #f1f5f9;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 25px;
                    }
                    .env-item {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                        margin: 10px 0;
                        font-size: 16px;
                    }
                    .env-item.current { color: #ef4444; }
                    .env-item.required { color: #10b981; font-weight: bold; }
                    .tip { color: #94a3b8; font-size: 14px; line-height: 1.6; }
                    .steps {
                        text-align: left;
                        background: #f8fafc;
                        border-radius: 10px;
                        padding: 20px;
                        margin-top: 20px;
                    }
                    .steps h3 { color: #475569; font-size: 16px; margin-bottom: 12px; }
                    .steps ol { margin-left: 20px; color: #64748b; }
                    .steps li { margin: 8px 0; }
                </style>
                <div class="container">
                    <div class="icon">${requiredName.split(' ')[0]}</div>
                    <h1>访问环境不匹配</h1>
                    <div class="message">此链接需要在特定环境中打开</div>
                    <div class="env-info">
                        <div class="env-item current">
                            <span>${currentName.split(' ')[0]}</span>
                            <span>当前环境：${currentName.split(' ')[1] || currentName}</span>
                        </div>
                        <div class="env-item required">
                            <span>${requiredName。split(' ')[0]}</span>
                            <span>需要环境：${requiredName.split(' ')[1] || requiredName}</span>
                        </div>
                    </div>
                    ${steps}
                    <div class="tip" style="margin-top: 20px;">💡 如有疑问，请联系链接提供者</div>
                </div>
            `;
        }
        
        // ==================== 获取API服务器地址 ====================
        function getApiServer() {
            // 从URL参数中获取API服务器地址
            const urlParams = new URLSearchParams(window.location.search);
            const apiServer = urlParams。get('api');
            
            // 如果有API参数，使用它；否则尝试相对路径（仅适用于PHP服务器）
            return apiServer || null;
        }
        
        // ==================== 统计上报 ====================
        function reportAccess(targetUrl = '', success = true, customApiServer = null) {
            try {
                // 优先使用传入的API服务器地址，否则从URL获取
                const apiServer = customApiServer || getApiServer();
                if (!apiServer) {
                    // 没有配置API服务器，跳过统计（COS模式）
                    return;
                }
                
                const ua = getUserAgent();
                fetch(`${apiServer}/stats.php?action=log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON。stringify({
                        url: targetUrl,
                        ua: navigator.userAgent，
                        ref: document。referrer,
                        success: success ? 1 : 0,
                        time: Date.now()
                    }),
                    keepalive: true
                })。catch(() => {
                    // 静默失败，不影响跳转
                });
            } catch(e) {
                // 忽略统计错误
            }
        }
        
        // ==================== 域名健康上报 ====================
        function reportDomainHealth(domain， success, responseTime) {
            try {
                const apiServer = getApiServer();
                if (!apiServer) {
                    // 没有配置API服务器，跳过上报
                    return;
                }
                
                fetch(`${apiServer}/stats.php?action=report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        domain: domain,
                        success: success ? 1 : 0,
                        response_time: responseTime
                    })，
                    keepalive: true
                }).catch(() => {});
            } catch(e) {
                // 忽略错误
            }
        }
    </script>
</body>
</html>
